# Spark开发环境搭建

[一、安装Spark](https://github.com/heibaiying/BigData-Notes/blob/master/notes/installation/Spark开发环境搭建.md#一安装Spark)
[二、词频统计案例](https://github.com/heibaiying/BigData-Notes/blob/master/notes/installation/Spark开发环境搭建.md#二词频统计案例)
[三、Scala开发环境配置](https://github.com/heibaiying/BigData-Notes/blob/master/notes/installation/Spark开发环境搭建.md#三Scala开发环境配置)

## 一、安装Spark

### 1.1 下载并解压

官方下载地址：http://spark.apache.org/downloads.html ，选择 Spark 版本和对应的 Hadoop 版本后再下载：

[![img](https://camo.githubusercontent.com/50ce84ce37fb45e049fab65277cc95046c933582/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d646f776e6c6f61642e706e67)](https://camo.githubusercontent.com/50ce84ce37fb45e049fab65277cc95046c933582/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d646f776e6c6f61642e706e67)

解压安装包：

```
# tar -zxvf  spark-2.2.3-bin-hadoop2.6.tgz
```

### 1.2 配置环境变量

```
# vim /etc/profile
```

添加环境变量：

```
export SPARK_HOME=/usr/app/spark-2.2.3-bin-hadoop2.6
export  PATH=${SPARK_HOME}/bin:$PATH
```

使得配置的环境变量立即生效：

```
# source /etc/profile
```

### 1.3 Local模式

Local 模式是最简单的一种运行方式，它采用单节点多线程方式运行，不用部署，开箱即用，适合日常测试开发。

```
# 启动spark-shell
spark-shell --master local[2]
```

- **local**：只启动一个工作线程；
- **local[k]**：启动 k 个工作线程；
- **local[\*]**：启动跟 cpu 数目相同的工作线程数。

[![img](https://camo.githubusercontent.com/92f69dfdff9e8babcf8c04e1a4867024b7a5ed63/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2d6c6f63616c2e706e67)](https://camo.githubusercontent.com/92f69dfdff9e8babcf8c04e1a4867024b7a5ed63/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2d6c6f63616c2e706e67)



进入 spark-shell 后，程序已经自动创建好了上下文 `SparkContext`，等效于执行了下面的 Scala 代码：

```
val conf = new SparkConf().setAppName("Spark shell").setMaster("local[2]")
val sc = new SparkContext(conf)
```

## 二、词频统计案例

安装完成后可以先做一个简单的词频统计例子，感受 spark 的魅力。准备一个词频统计的文件样本 `wc.txt`，内容如下：

```
hadoop,spark,hadoop
spark,flink,flink,spark
hadoop,hadoop
```

在 scala 交互式命令行中执行如下 Scala 语句：

```
val file = spark.sparkContext.textFile("file:///usr/app/wc.txt")
val wordCounts = file.flatMap(line => line.split(",")).map((word => (word, 1))).reduceByKey(_ + _)
wordCounts.collect
```

执行过程如下，可以看到已经输出了词频统计的结果：

[![img](https://camo.githubusercontent.com/82942ac5285a6c76c6b52b95f9857b222f2a2e51/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2e706e67)](https://camo.githubusercontent.com/82942ac5285a6c76c6b52b95f9857b222f2a2e51/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2e706e67)

同时还可以通过 Web UI 查看作业的执行情况，访问端口为 `4040`：

[![img](https://camo.githubusercontent.com/de56640632223716b5c83f4e5e0a471a0046f671/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2d7765622d75692e706e67)](https://camo.githubusercontent.com/de56640632223716b5c83f4e5e0a471a0046f671/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f737061726b2d7368656c6c2d7765622d75692e706e67)

## 三、Scala开发环境配置

Spark 是基于 Scala 语言进行开发的，分别提供了基于 Scala、Java、Python 语言的 API，如果你想使用 Scala 语言进行开发，则需要搭建 Scala 语言的开发环境。

### 3.1 前置条件

Scala 的运行依赖于 JDK，所以需要你本机有安装对应版本的 JDK，最新的 Scala 2.12.x 需要 JDK 1.8+。

### 3.2 安装Scala插件

IDEA 默认不支持 Scala 语言的开发，需要通过插件进行扩展。打开 IDEA，依次点击 **File** => **settings**=> **plugins** 选项卡，搜索 Scala 插件 (如下图)。找到插件后进行安装，并重启 IDEA 使得安装生效。

[![img](https://camo.githubusercontent.com/84287c17ac59d410261f074bc0e6f5f395e3d2b0/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d706c7567696e2e706e67)](https://camo.githubusercontent.com/84287c17ac59d410261f074bc0e6f5f395e3d2b0/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d706c7567696e2e706e67)

### 3.3 创建Scala项目

在 IDEA 中依次点击 **File** => **New** => **Project** 选项卡，然后选择创建 `Scala—IDEA` 工程：

[![img](https://camo.githubusercontent.com/7f318b463cfe8b4d48483a6a75846837909ecc78/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d6e657770726f6a6563742d7363616c612e706e67)](https://camo.githubusercontent.com/7f318b463cfe8b4d48483a6a75846837909ecc78/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d6e657770726f6a6563742d7363616c612e706e67)

### 3.4 下载Scala SDK

#### 1. 方式一

此时看到 `Scala SDK` 为空，依次点击 `Create` => `Download` ，选择所需的版本后，点击 `OK` 按钮进行下载，下载完成点击 `Finish` 进入工程。

[![img](https://camo.githubusercontent.com/6dfbec3d30094a23e7f7eccd8cbf88eaecf559c6/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d73656c6563742e706e67)](https://camo.githubusercontent.com/6dfbec3d30094a23e7f7eccd8cbf88eaecf559c6/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d73656c6563742e706e67)

#### 2. 方式二

方式一是 Scala 官方安装指南里使用的方式，但下载速度通常比较慢，且这种安装下并没有直接提供 Scala 命令行工具。所以个人推荐到官网下载安装包进行安装，下载地址：https://www.scala-lang.org/download/

这里我的系统是 Windows，下载 msi 版本的安装包后，一直点击下一步进行安装，安装完成后会自动配置好环境变量。

[![img](https://camo.githubusercontent.com/9ce80e882f7794c7e4fe173ebd637140cb7579fc/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d6f746865722d7265736f75726365732e706e67)](https://camo.githubusercontent.com/9ce80e882f7794c7e4fe173ebd637140cb7579fc/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d6f746865722d7265736f75726365732e706e67)

由于安装时已经自动配置好环境变量，所以 IDEA 会自动选择对应版本的 SDK。

[![img](https://camo.githubusercontent.com/0cd3b51d68bc577d27bc0de16536629c5d8d62c9/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d322e312e382e706e67)](https://camo.githubusercontent.com/0cd3b51d68bc577d27bc0de16536629c5d8d62c9/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d322e312e382e706e67)

### 3.5 创建Hello World

在工程 `src` 目录上右击 **New** => **Scala class** 创建 `Hello.scala`。输入代码如下，完成后点击运行按钮，成功运行则代表搭建成功。

[![img](https://camo.githubusercontent.com/6b555842babd87f8a20fa267e88a559c61a408ba/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d68656c6c6f2d776f726c642e706e67)](https://camo.githubusercontent.com/6b555842babd87f8a20fa267e88a559c61a408ba/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d68656c6c6f2d776f726c642e706e67)

### 3.6 切换Scala版本

在日常的开发中，由于对应软件（如 Spark）的版本切换，可能导致需要切换 Scala 的版本，则可以在 `Project Structures` 中的 `Global Libraries` 选项卡中进行切换。

[![img](https://camo.githubusercontent.com/6acf002b8666ccce4c5c1c2f4fb7d42c108366d3/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d6368616e67652e706e67)](https://camo.githubusercontent.com/6acf002b8666ccce4c5c1c2f4fb7d42c108366d3/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f696465612d7363616c612d6368616e67652e706e67)

### 3.7 可能出现的问题

在 IDEA 中有时候重新打开项目后，右击并不会出现新建 `scala` 文件的选项，或者在编写时没有 Scala 语法提示，此时可以先删除 `Global Libraries` 中配置好的 SDK，之后再重新添加：

[![img](https://camo.githubusercontent.com/0b691d45a7b9f6fab239ec61b7a375a131eec57c/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d73646b2e706e67)](https://camo.githubusercontent.com/0b691d45a7b9f6fab239ec61b7a375a131eec57c/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f7363616c612d73646b2e706e67)

**另外在 IDEA 中以本地模式运行 Spark 项目是不需要在本机搭建 Spark 和 Hadoop 环境的。**

[![img](https://camo.githubusercontent.com/6e4d664b5691228295efc55f71fcc05b107514b6/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f77656978696e2d646573632e706e67)](https://camo.githubusercontent.com/6e4d664b5691228295efc55f71fcc05b107514b6/68747470733a2f2f67697465652e636f6d2f68656962616979696e672f426967446174612d4e6f7465732f7261772f6d61737465722f70696374757265732f77656978696e2d646573632e706e67)