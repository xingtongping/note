### 									SpringCloud å…¥é—¨

Spring Cloudå„ä¸ªç»„ä»¶

- `Eureka` æœåŠ¡å‘ç°æ¡†æ¶
- `Ribbon` è¿›ç¨‹å†…è´Ÿè½½å‡è¡¡å™¨
- `Open Feign` æœåŠ¡è°ƒç”¨æ˜ å°„
- `Hystrix` æœåŠ¡é™çº§ç†”æ–­å™¨
- `Zuul` å¾®æœåŠ¡ç½‘å…³
- `Config` å¾®æœåŠ¡ç»Ÿä¸€é…ç½®ä¸­å¿ƒ
- `Bus` æ¶ˆæ¯æ€»çº¿

æˆ‘æ‰€ç†è§£çš„ `Spring Cloud` å°±æ˜¯å¾®æœåŠ¡ç³»ç»Ÿæ¶æ„çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œåœ¨å¹³æ—¶æˆ‘ä»¬æ„å»ºå¾®æœåŠ¡çš„è¿‡ç¨‹ä¸­éœ€è¦åšå¦‚ **æœåŠ¡å‘ç°æ³¨å†Œ** ã€**é…ç½®ä¸­å¿ƒ** ã€**æ¶ˆæ¯æ€»çº¿** ã€**è´Ÿè½½å‡è¡¡** ã€**æ–­è·¯å™¨** ã€**æ•°æ®ç›‘æ§** ç­‰æ“ä½œï¼Œè€Œ Spring Cloud ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€å¥—ç®€æ˜“çš„ç¼–ç¨‹æ¨¡å‹ï¼Œä½¿æˆ‘ä»¬èƒ½åœ¨ Spring Boot çš„åŸºç¡€ä¸Šè½»æ¾åœ°å®ç°å¾®æœåŠ¡é¡¹ç›®çš„æ„å»ºã€‚



## Spring Cloud çš„æœåŠ¡å‘ç°æ¡†æ¶â€”â€”Eureka

`Eureka`æ˜¯åŸºäº`REST`ï¼ˆä»£è¡¨æ€§çŠ¶æ€è½¬ç§»ï¼‰çš„æœåŠ¡ï¼Œä¸»è¦åœ¨ `AWS` äº‘ä¸­ç”¨äºå®šä½æœåŠ¡ï¼Œä»¥å®ç°è´Ÿè½½å‡è¡¡å’Œä¸­é—´å±‚æœåŠ¡å™¨çš„æ•…éšœè½¬ç§»ã€‚æˆ‘ä»¬ç§°æ­¤æœåŠ¡ä¸º`Eureka`æœåŠ¡å™¨ã€‚Eurekaè¿˜å¸¦æœ‰ä¸€ä¸ªåŸºäº `Java` çš„å®¢æˆ·ç«¯ç»„ä»¶ `Eureka Client`ï¼Œå®ƒä½¿ä¸æœåŠ¡çš„äº¤äº’å˜å¾—æ›´åŠ å®¹æ˜“ã€‚å®¢æˆ·ç«¯è¿˜å…·æœ‰ä¸€ä¸ªå†…ç½®çš„è´Ÿè½½å¹³è¡¡å™¨ï¼Œå¯ä»¥æ‰§è¡ŒåŸºæœ¬çš„å¾ªç¯è´Ÿè½½å¹³è¡¡ã€‚æ€»çš„æ¥è¯´ï¼Œ`Eureka` å°±æ˜¯ä¸€ä¸ªæœåŠ¡å‘ç°æ¡†æ¶ã€‚

## è´Ÿè½½å‡è¡¡ä¹‹ Ribbon

`Ribbon` æ˜¯ `Netflix` å…¬å¸çš„ä¸€ä¸ªå¼€æºçš„è´Ÿè½½å‡è¡¡ é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯/è¿›ç¨‹å†…è´Ÿè½½å‡è¡¡å™¨ï¼Œ**è¿è¡Œåœ¨æ¶ˆè´¹è€…ç«¯**ã€‚

### ä»€ä¹ˆæ˜¯ `RestTemplate`?

**`RestTemplate`æ˜¯`Spring`æä¾›çš„ä¸€ä¸ªè®¿é—®HttpæœåŠ¡çš„å®¢æˆ·ç«¯ç±»**ï¼Œæ€ä¹ˆè¯´å‘¢ï¼Ÿå°±æ˜¯å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨æ˜¯ä½¿ç”¨çš„ `RestTemplate`

### Nginx å’Œ Ribbon çš„å¯¹æ¯”

æåˆ° **è´Ÿè½½å‡è¡¡** å°±ä¸å¾—ä¸æåˆ°å¤§åé¼é¼çš„ `Nignx` äº†ï¼Œè€Œå’Œ `Ribbon` ä¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯ä¸€ç§**é›†ä¸­å¼**çš„è´Ÿè½½å‡è¡¡å™¨ã€‚

ä½•ä¸ºé›†ä¸­å¼å‘¢ï¼Ÿç®€å•ç†è§£å°±æ˜¯ **å°†æ‰€æœ‰è¯·æ±‚éƒ½é›†ä¸­èµ·æ¥ï¼Œç„¶åå†è¿›è¡Œè´Ÿè½½å‡è¡¡**ã€‚

`Nginx` æ˜¯æ¥æ”¶äº†æ‰€æœ‰çš„è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡çš„ï¼Œè€Œå¯¹äº `Ribbon` æ¥è¯´å®ƒæ˜¯åœ¨æ¶ˆè´¹è€…ç«¯è¿›è¡Œçš„è´Ÿè½½å‡è¡¡ã€‚å¦‚ä¸‹å›¾ã€‚

![image-20200225155329295](C:\Users\jiang\AppData\Roaming\Typora\typora-user-images\image-20200225155329295.png)

è¯·æ³¨æ„ `Request` çš„ä½ç½®ï¼Œåœ¨ `Nginx` ä¸­è¯·æ±‚æ˜¯å…ˆè¿›å…¥è´Ÿè½½å‡è¡¡å™¨ï¼Œè€Œåœ¨ `Ribbon` ä¸­æ˜¯å…ˆåœ¨å®¢æˆ·ç«¯è¿›è¡Œè´Ÿè½½å‡è¡¡æ‰è¿›è¡Œè¯·æ±‚çš„ã€‚



### Ribbon çš„å‡ ç§è´Ÿè½½å‡è¡¡ç®—æ³•

åœ¨ `Ribbon` ä¸­æœ‰æ›´å¤šçš„è´Ÿè½½å‡è¡¡è°ƒåº¦ç®—æ³•ï¼Œå…¶é»˜è®¤æ˜¯ä½¿ç”¨çš„ `RoundRobinRule` è½®è¯¢ç­–ç•¥ã€‚

- **`RoundRobinRule`**ï¼šè½®è¯¢ç­–ç•¥ã€‚`Ribbon` é»˜è®¤é‡‡ç”¨çš„ç­–ç•¥ã€‚è‹¥ç»è¿‡ä¸€è½®è½®è¯¢æ²¡æœ‰æ‰¾åˆ°å¯ç”¨çš„ `provider`ï¼Œå…¶æœ€å¤šè½®è¯¢ 10 è½®ã€‚è‹¥æœ€ç»ˆè¿˜æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿”å› `null`ã€‚
- **`RandomRule`**: éšæœºç­–ç•¥ï¼Œä»æ‰€æœ‰å¯ç”¨çš„ `provider` ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªã€‚
- **`RetryRule`**: é‡è¯•ç­–ç•¥ã€‚å…ˆæŒ‰ç…§ `RoundRobinRule` ç­–ç•¥è·å– `provider`ï¼Œè‹¥è·å–å¤±è´¥ï¼Œåˆ™åœ¨æŒ‡å®šçš„æ—¶é™å†…é‡è¯•ã€‚é»˜è®¤çš„æ—¶é™ä¸º 500 æ¯«ç§’ã€‚



å½“ç„¶ï¼Œåœ¨ `Ribbon` ä¸­ä½ è¿˜å¯ä»¥**è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç®—æ³•**ï¼Œä½ åªéœ€è¦å®ç° `IRule` æ¥å£ï¼Œç„¶åä¿®æ”¹é…ç½®æ–‡ä»¶æˆ–è€…è‡ªå®šä¹‰ `Java Config` ç±»ã€‚

```
providerName:
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
```



## ä»€ä¹ˆæ˜¯ Open Feign

æœ‰äº† `Eureka` ï¼Œ`RestTemplate` ï¼Œ`Ribbon`ï¼Œ æˆ‘ä»¬å°±å¯ä»¥æ„‰å¿«åœ°è¿›è¡ŒæœåŠ¡é—´çš„è°ƒç”¨äº†ï¼Œä½†æ˜¯ä½¿ç”¨ `RestTemplate` è¿˜æ˜¯ä¸æ–¹ä¾¿ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½è¦è¿›è¡Œè¿™æ ·çš„è°ƒç”¨ã€‚

```
@Autowired
private RestTemplate restTemplate;
// è¿™é‡Œæ˜¯æä¾›è€…Açš„ipåœ°å€ï¼Œä½†æ˜¯å¦‚æœä½¿ç”¨äº† Eureka é‚£ä¹ˆå°±åº”è¯¥æ˜¯æä¾›è€…Açš„åç§°
private static final String SERVICE_PROVIDER_A = "http://localhost:8081";

@PostMapping("/judge")
public boolean judge(@RequestBody Request request) {
    String url = SERVICE_PROVIDER_A + "/service1";
    // æ˜¯ä¸æ˜¯å¤ªéº»çƒ¦äº†ï¼Ÿï¼Ÿï¼Ÿæ¯æ¬¡éƒ½è¦ urlã€è¯·æ±‚ã€è¿”å›ç±»å‹çš„ 
    return restTemplate.postForObject(url, request, Boolean.class);
}
```



`OpenFeign` ä¹Ÿæ˜¯è¿è¡Œåœ¨æ¶ˆè´¹è€…ç«¯çš„ï¼Œä½¿ç”¨ `Ribbon` è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œæ‰€ä»¥ `OpenFeign` ç›´æ¥å†…ç½®äº† `Ribbon`ã€‚

åœ¨å¯¼å…¥äº† `Open Feign` ä¹‹åæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œæ„‰å¿«ç¼–å†™ `Consumer` ç«¯ä»£ç äº†ã€‚

```
// ä½¿ç”¨ @FeignClient æ³¨è§£æ¥æŒ‡å®šæä¾›è€…çš„åå­—
@FeignClient(value = "eureka-client-provider")
public interface TestClient {
    // è¿™é‡Œä¸€å®šè¦æ³¨æ„éœ€è¦ä½¿ç”¨çš„æ˜¯æä¾›è€…é‚£ç«¯çš„è¯·æ±‚ç›¸å¯¹è·¯å¾„ï¼Œè¿™é‡Œå°±ç›¸å½“äºæ˜ å°„äº†
    @RequestMapping(value = "/provider/xxx",
    method = RequestMethod.POST)
    CommonResponse<List<Plan>> getPlans(@RequestBody planGetRequest request);
}
```



ç„¶åæˆ‘ä»¬åœ¨ `Controller` å°±å¯ä»¥åƒåŸæ¥è°ƒç”¨ `Service` å±‚ä»£ç ä¸€æ ·è°ƒç”¨å®ƒäº†ã€‚

```
@RestController
public class TestController {
    // è¿™é‡Œå°±ç›¸å½“äºåŸæ¥è‡ªåŠ¨æ³¨å…¥çš„ Service
    @Autowired
    private TestClient testClient;
    // controller è°ƒç”¨ service å±‚ä»£ç 
    @RequestMapping(value = "/test", method = RequestMethod.POST)
    public CommonResponse<List<Plan>> get(@RequestBody planGetRequest request) {
        return testClient.getPlans(request);
    }
}
```



## å¿…ä¸å¯å°‘çš„ Hystrix

### ä»€ä¹ˆæ˜¯ Hystrixä¹‹ç†”æ–­å’Œé™çº§

`Hystrix` å°±æ˜¯ä¸€ä¸ªèƒ½è¿›è¡Œ **ç†”æ–­** å’Œ **é™çº§** çš„åº“ï¼Œé€šè¿‡ä½¿ç”¨å®ƒèƒ½æé«˜æ•´ä¸ªç³»ç»Ÿçš„å¼¹æ€§ã€‚

è¯·æ³¨æ„ï¼Œä¸ºä»€ä¹ˆé˜»å¡ä¼šå´©æºƒã€‚å› ä¸ºè¿™äº›è¯·æ±‚ä¼šæ¶ˆè€—å ç”¨ç³»ç»Ÿçš„çº¿ç¨‹ã€IO ç­‰èµ„æºï¼Œæ¶ˆè€—å®Œä½ è¿™ä¸ªç³»ç»ŸæœåŠ¡å™¨ä¸å°±å´©äº†ä¹ˆã€‚



å¤§éƒ¨åˆ†è¯·æ±‚é˜»å¡ï¼Œå¯¼è‡´æœåŠ¡é›ªå´©

æ‰€è°“ **ç†”æ–­** å°±æ˜¯æœåŠ¡é›ªå´©çš„ä¸€ç§æœ‰æ•ˆè§£å†³æ–¹æ¡ˆã€‚å½“æŒ‡å®šæ—¶é—´çª—å†…çš„è¯·æ±‚å¤±è´¥ç‡è¾¾åˆ°è®¾å®šé˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿå°†é€šè¿‡ **æ–­è·¯å™¨** ç›´æ¥å°†æ­¤è¯·æ±‚é“¾è·¯æ–­å¼€ã€‚

ä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢æœåŠ¡Bè°ƒç”¨æœåŠ¡Cåœ¨æŒ‡å®šæ—¶é—´çª—å†…ï¼Œè°ƒç”¨çš„å¤±è´¥ç‡åˆ°è¾¾äº†ä¸€å®šçš„å€¼ï¼Œé‚£ä¹ˆ `Hystrix` åˆ™ä¼šè‡ªåŠ¨å°† æœåŠ¡Bä¸C ä¹‹é—´çš„è¯·æ±‚éƒ½æ–­äº†ï¼Œä»¥å…å¯¼è‡´æœåŠ¡é›ªå´©ç°è±¡ã€‚

å…¶å®è¿™é‡Œæ‰€è®²çš„ **ç†”æ–­** å°±æ˜¯æŒ‡çš„ `Hystrix` ä¸­çš„ **æ–­è·¯å™¨æ¨¡å¼** ï¼Œä½ å¯ä»¥ä½¿ç”¨ç®€å•çš„ `@HystrixCommand` æ³¨è§£æ¥æ ‡æ³¨æŸä¸ªæ–¹æ³•ï¼Œè¿™æ · `Hystrix` å°±ä¼šä½¿ç”¨ **æ–­è·¯å™¨** æ¥â€œåŒ…è£…â€è¿™ä¸ªæ–¹æ³•ï¼Œæ¯å½“è°ƒç”¨æ—¶é—´è¶…è¿‡æŒ‡å®šæ—¶é—´æ—¶(é»˜è®¤ä¸º1000ms)ï¼Œæ–­è·¯å™¨å°†ä¼šä¸­æ–­å¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ã€‚

å½“ç„¶ä½ å¯ä»¥å¯¹è¿™ä¸ªæ³¨è§£çš„å¾ˆå¤šå±æ€§è¿›è¡Œè®¾ç½®ï¼Œæ¯”å¦‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåƒè¿™æ ·ã€‚

```
@HystrixCommand(
    commandProperties = {@HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "1200")}
)
public List<Xxx> getXxxx() {
    // ...çœç•¥ä»£ç é€»è¾‘
}
```



**é™çº§æ˜¯ä¸ºäº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œå½“ä¸€ä¸ªæ–¹æ³•è°ƒç”¨å¼‚å¸¸æ—¶ï¼Œé€šè¿‡æ‰§è¡Œå¦ä¸€ç§ä»£ç é€»è¾‘æ¥ç»™ç”¨æˆ·å‹å¥½çš„å›å¤**ã€‚è¿™ä¹Ÿå°±å¯¹åº”ç€ `Hystrix` çš„ **åå¤‡å¤„ç†** æ¨¡å¼ã€‚ä½ å¯ä»¥é€šè¿‡è®¾ç½® `fallbackMethod` æ¥ç»™ä¸€ä¸ªæ–¹æ³•è®¾ç½®å¤‡ç”¨çš„ä»£ç é€»è¾‘ã€‚æ¯”å¦‚è¿™ä¸ªæ—¶å€™æœ‰ä¸€ä¸ªçƒ­ç‚¹æ–°é—»å‡ºç°äº†ï¼Œæˆ‘ä»¬ä¼šæ¨èç»™ç”¨æˆ·æŸ¥çœ‹è¯¦æƒ…ï¼Œç„¶åç”¨æˆ·ä¼šé€šè¿‡idå»æŸ¥è¯¢æ–°é—»çš„è¯¦æƒ…ï¼Œä½†æ˜¯å› ä¸ºè¿™æ¡æ–°é—»å¤ªç«äº†(æ¯”å¦‚æœ€è¿‘ä»€ä¹ˆ*æ˜“å¯¹å§)ï¼Œå¤§é‡ç”¨æˆ·åŒæ—¶è®¿é—®å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¿›è¡Œ **æœåŠ¡é™çº§** ï¼Œä¸€äº›è¯·æ±‚ä¼šåšä¸€äº›é™çº§å¤„ç†æ¯”å¦‚å½“å‰äººæ•°å¤ªå¤šè¯·ç¨åæŸ¥çœ‹ç­‰ç­‰ã€‚

```
// æŒ‡å®šäº†åå¤‡æ–¹æ³•è°ƒç”¨
@HystrixCommand(fallbackMethod = "getHystrixNews")
@GetMapping("/get/news")
public News getNews(@PathVariable("id") int id) {
    // è°ƒç”¨æ–°é—»ç³»ç»Ÿçš„è·å–æ–°é—»api ä»£ç é€»è¾‘çœç•¥
}
// 
public News getHystrixNews(@PathVariable("id") int id) {
    // åšæœåŠ¡é™çº§
    // è¿”å›å½“å‰äººæ•°å¤ªå¤šï¼Œè¯·ç¨åæŸ¥çœ‹
}
```





## å¾®æœåŠ¡ç½‘å…³â€”â€”Zuul

å¤§å®¶å¯¹ç½‘å…³åº”è¯¥å¾ˆç†Ÿå§ï¼Œç®€å•æ¥è®²ç½‘å…³æ˜¯ç³»ç»Ÿå”¯ä¸€å¯¹å¤–çš„å…¥å£ï¼Œä»‹äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ä¹‹é—´ï¼Œç”¨äºå¯¹è¯·æ±‚è¿›è¡Œ**é‰´æƒ**ã€**é™æµ**ã€ **è·¯ç”±**ã€**ç›‘æ§**ç­‰åŠŸèƒ½ã€‚

æ²¡ç½‘å…³æœ‰çš„åŠŸèƒ½ï¼Œ`Zuul` åŸºæœ¬éƒ½æœ‰ã€‚è€Œ `Zuul` ä¸­æœ€å…³é”®çš„å°±æ˜¯ **è·¯ç”±å’Œè¿‡æ»¤å™¨** äº†ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­ `Zuul` çš„æ ‡é¢˜å°±æ˜¯

> Router and Filter : Zuul

### Zuul çš„è·¯ç”±åŠŸèƒ½

é¦–å…ˆï¼Œ`Zuul` éœ€è¦å‘ `Eureka` è¿›è¡Œæ³¨å†Œï¼Œæ³¨å†Œæœ‰å•¥å¥½å¤„å‘¢ï¼Ÿ

ä½ å‚»å‘€ï¼Œ`Consumer` éƒ½å‘ `Eureka Server` è¿›è¡Œæ³¨å†Œäº†ï¼Œæˆ‘ç½‘å…³æ˜¯ä¸æ˜¯åªè¦æ³¨å†Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰ `Consumer` çš„ä¿¡æ¯äº†ï¼Ÿ

æ‹¿åˆ°ä¿¡æ¯æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿ

æˆ‘æ‹¿åˆ°ä¿¡æ¯æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è·å–æ‰€æœ‰çš„ `Consumer` çš„å…ƒæ•°æ®(åç§°ï¼Œipï¼Œç«¯å£)ï¼Ÿ

æ‹¿åˆ°è¿™äº›å…ƒæ•°æ®æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿæ‹¿åˆ°äº†æˆ‘ä»¬æ˜¯ä¸æ˜¯ç›´æ¥å¯ä»¥åš**è·¯ç”±æ˜ å°„**ï¼Ÿæ¯”å¦‚åŸæ¥ç”¨æˆ·è°ƒç”¨ `Consumer1` çš„æ¥å£ `localhost:8001/studentInfo/update` è¿™ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·è¿›è¡Œè°ƒç”¨äº†å‘¢ï¼Ÿ`localhost:9000/consumer1/studentInfo/update` å‘¢ï¼Ÿä½ è¿™æ ·æ˜¯ä¸æ˜¯æç„¶å¤§æ‚Ÿäº†ï¼Ÿ

> è¿™é‡Œçš„urlä¸ºäº†è®©æ›´å¤šäººçœ‹æ‡‚æ‰€ä»¥æ²¡æœ‰ä½¿ç”¨ restful é£æ ¼ã€‚

ä¸Šé¢çš„ä½ ç†è§£äº†ï¼Œé‚£ä¹ˆå°±èƒ½ç†è§£å…³äº `Zuul` æœ€åŸºæœ¬çš„é…ç½®äº†ï¼Œçœ‹ä¸‹é¢ã€‚

```
server:
  port: 9000
eureka:
  client:
    service-url:
      # è¿™é‡Œåªè¦æ³¨å†Œ Eureka å°±è¡Œäº†
      defaultZone: http://localhost:9997/eureka
```

ç„¶ååœ¨å¯åŠ¨ç±»ä¸ŠåŠ å…¥ `@EnableZuulProxy` æ³¨è§£å°±è¡Œäº†ã€‚æ²¡é”™ï¼Œå°±æ˜¯é‚£ä¹ˆç®€å•ğŸ˜ƒã€‚

#### ç»Ÿä¸€å‰ç¼€

è¿™ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥åœ¨å‰é¢åŠ ä¸€ä¸ªç»Ÿä¸€çš„å‰ç¼€ï¼Œæ¯”å¦‚æˆ‘ä»¬åˆšåˆšè°ƒç”¨çš„æ˜¯ `localhost:9000/consumer1/studentInfo/update`ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬åœ¨ `yaml` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ã€‚

```
zuul:
  prefix: /zuul
```

è¿™æ ·æˆ‘ä»¬å°±éœ€è¦é€šè¿‡ `localhost:9000/zuul/consumer1/studentInfo/update` æ¥è¿›è¡Œè®¿é—®äº†ã€‚

#### è·¯ç”±ç­–ç•¥é…ç½®

ä½ ä¼šå‘ç°å‰é¢çš„è®¿é—®æ–¹å¼(ç›´æ¥ä½¿ç”¨æœåŠ¡å)ï¼Œéœ€è¦å°†å¾®æœåŠ¡åç§°æš´éœ²ç»™ç”¨æˆ·ï¼Œä¼šå­˜åœ¨å®‰å…¨æ€§é—®é¢˜ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è‡ªå®šä¹‰è·¯å¾„æ¥æ›¿ä»£å¾®æœåŠ¡åç§°ï¼Œå³è‡ªå®šä¹‰è·¯ç”±ç­–ç•¥ã€‚

```
zuul:
  routes:
    consumer1: /FrancisQ1/**
    consumer2: /FrancisQ2/**
```

è¿™ä¸ªæ—¶å€™ä½ å°±å¯ä»¥ä½¿ç”¨ ``localhost:9000/zuul/FrancisQ1/studentInfo/update` è¿›è¡Œè®¿é—®äº†ã€‚

#### æœåŠ¡åå±è”½

è¿™ä¸ªæ—¶å€™ä½ åˆ«ä»¥ä¸ºä½ å¥½äº†ï¼Œä½ å¯ä»¥è¯•è¯•ï¼Œåœ¨ä½ é…ç½®å®Œè·¯ç”±ç­–ç•¥ä¹‹åä½¿ç”¨å¾®æœåŠ¡åç§°è¿˜æ˜¯å¯ä»¥è®¿é—®çš„ï¼Œè¿™ä¸ªæ—¶å€™ä½ éœ€è¦å°†æœåŠ¡åå±è”½ã€‚

```
zuul:
  ignore-services: "*"
```

#### è·¯å¾„å±è”½

`Zuul` è¿˜å¯ä»¥æŒ‡å®šå±è”½æ‰çš„è·¯å¾„ URIï¼Œå³åªè¦ç”¨æˆ·è¯·æ±‚ä¸­åŒ…å«æŒ‡å®šçš„ URI è·¯å¾„ï¼Œé‚£ä¹ˆè¯¥è¯·æ±‚å°†æ— æ³•è®¿é—®åˆ°æŒ‡å®šçš„æœåŠ¡ã€‚é€šè¿‡è¯¥æ–¹å¼å¯ä»¥é™åˆ¶ç”¨æˆ·çš„æƒé™ã€‚

```
zuul:
  ignore-patterns: **/auto/**
```

è¿™æ ·å…³äº auto çš„è¯·æ±‚æˆ‘ä»¬å°±å¯ä»¥è¿‡æ»¤æ‰äº†ã€‚

> ** ä»£è¡¨åŒ¹é…å¤šçº§ä»»æ„è·¯å¾„
>
> *ä»£è¡¨åŒ¹é…ä¸€çº§ä»»æ„è·¯å¾„

#### æ•æ„Ÿè¯·æ±‚å¤´å±è”½

é»˜è®¤æƒ…å†µä¸‹ï¼Œåƒ `Cookie`ã€`Set-Cookie` ç­‰æ•æ„Ÿè¯·æ±‚å¤´ä¿¡æ¯ä¼šè¢« `zuul` å±è”½æ‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™äº›é»˜è®¤å±è”½å»æ‰ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥æ·»åŠ è¦å±è”½çš„è¯·æ±‚å¤´ã€‚





### Zuul çš„è¿‡æ»¤åŠŸèƒ½

å¦‚æœè¯´ï¼Œè·¯ç”±åŠŸèƒ½æ˜¯ `Zuul` çš„åŸºæ“çš„è¯ï¼Œé‚£ä¹ˆ**è¿‡æ»¤å™¨**å°±æ˜¯ `Zuul`çš„åˆ©å™¨äº†ã€‚æ¯•ç«Ÿæ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ç½‘å…³(Zuul)ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿›è¡Œå„ç§è¿‡æ»¤ï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½å®ç° **é™æµ**ï¼Œ**ç°åº¦å‘å¸ƒ**ï¼Œ**æƒé™æ§åˆ¶** ç­‰ç­‰ã€‚

#### ç®€å•å®ç°ä¸€ä¸ªè¯·æ±‚æ—¶é—´æ—¥å¿—æ‰“å°

è¦å®ç°è‡ªå·±å®šä¹‰çš„ `Filter` æˆ‘ä»¬åªéœ€è¦ç»§æ‰¿ `ZuulFilter` ç„¶åå°†è¿™ä¸ªè¿‡æ»¤å™¨ç±»ä»¥ `@Component` æ³¨è§£åŠ å…¥ Spring å®¹å™¨ä¸­å°±è¡Œäº†ã€‚



è¿‡æ»¤å™¨ç±»å‹ï¼š`Pre`ã€`Routing`ã€`Post`ã€‚å‰ç½®`Pre`å°±æ˜¯åœ¨è¯·æ±‚ä¹‹å‰è¿›è¡Œè¿‡æ»¤ï¼Œ`Routing`è·¯ç”±è¿‡æ»¤å™¨å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æ‰€è®²çš„è·¯ç”±ç­–ç•¥ï¼Œè€Œ`Post`åç½®è¿‡æ»¤å™¨å°±æ˜¯åœ¨ `Response` ä¹‹å‰è¿›è¡Œè¿‡æ»¤çš„è¿‡æ»¤å™¨ã€‚ä½ å¯ä»¥è§‚å¯Ÿä¸Šå›¾ç»“åˆç€ç†è§£ï¼Œå¹¶ä¸”ä¸‹é¢æˆ‘ä¼šç»™å‡ºç›¸åº”çš„æ³¨é‡Šã€‚

```
// åŠ å…¥Springå®¹å™¨
@Component
public class PreRequestFilter extends ZuulFilter {
    // è¿”å›è¿‡æ»¤å™¨ç±»å‹ è¿™é‡Œæ˜¯å‰ç½®è¿‡æ»¤å™¨
    @Override
    public String filterType() {
        return FilterConstants.PRE_TYPE;
    }
    // æŒ‡å®šè¿‡æ»¤é¡ºåº è¶Šå°è¶Šå…ˆæ‰§è¡Œï¼Œè¿™é‡Œç¬¬ä¸€ä¸ªæ‰§è¡Œ
    // å½“ç„¶ä¸æ˜¯åªçœŸæ­£ç¬¬ä¸€ä¸ª åœ¨Zuulå†…ç½®ä¸­æœ‰å…¶ä»–è¿‡æ»¤å™¨ä¼šå…ˆæ‰§è¡Œ
    // é‚£æ˜¯å†™æ­»çš„ æ¯”å¦‚ SERVLET_DETECTION_FILTER_ORDER = -3
    @Override
    public int filterOrder() {
        return 0;
    }
    // ä»€ä¹ˆæ—¶å€™è¯¥è¿›è¡Œè¿‡æ»¤
    // è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œä¸€äº›åˆ¤æ–­ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿‡æ»¤æ‰ä¸€äº›ä¸ç¬¦åˆè§„å®šçš„è¯·æ±‚ç­‰ç­‰
    @Override
    public boolean shouldFilter() {
        return true;
    }
    // å¦‚æœè¿‡æ»¤å™¨å…è®¸é€šè¿‡åˆ™æ€ä¹ˆè¿›è¡Œå¤„ç†
    @Override
    public Object run() throws ZuulException {
        // è¿™é‡Œæˆ‘è®¾ç½®äº†å…¨å±€çš„RequestContextå¹¶è®°å½•äº†è¯·æ±‚å¼€å§‹æ—¶é—´
        RequestContext ctx = RequestContext.getCurrentContext();
        ctx.set("startTime", System.currentTimeMillis());
        return null;
    }
}
// lombokçš„æ—¥å¿—
@Slf4j
// åŠ å…¥ Spring å®¹å™¨
@Component
public class AccessLogFilter extends ZuulFilter {
    // æŒ‡å®šè¯¥è¿‡æ»¤å™¨çš„è¿‡æ»¤ç±»å‹
    // æ­¤æ—¶æ˜¯åç½®è¿‡æ»¤å™¨
    @Override
    public String filterType() {
        return FilterConstants.POST_TYPE;
    }
    // SEND_RESPONSE_FILTER_ORDER æ˜¯æœ€åä¸€ä¸ªè¿‡æ»¤å™¨
    // æˆ‘ä»¬æ­¤è¿‡æ»¤å™¨åœ¨å®ƒä¹‹å‰æ‰§è¡Œ
    @Override
    public int filterOrder() {
        return FilterConstants.SEND_RESPONSE_FILTER_ORDER - 1;
    }
    @Override
    public boolean shouldFilter() {
        return true;
    }
    // è¿‡æ»¤æ—¶æ‰§è¡Œçš„ç­–ç•¥
    @Override
    public Object run() throws ZuulException {
        RequestContext context = RequestContext.getCurrentContext();
        HttpServletRequest request = context.getRequest();
        // ä»RequestContextè·å–åŸå…ˆçš„å¼€å§‹æ—¶é—´ å¹¶é€šè¿‡å®ƒè®¡ç®—æ•´ä¸ªæ—¶é—´é—´éš”
        Long startTime = (Long) context.get("startTime");
        // è¿™é‡Œæˆ‘å¯ä»¥è·å–HttpServletRequestæ¥è·å–URIå¹¶ä¸”æ‰“å°å‡ºæ¥
        String uri = request.getRequestURI();
        long duration = System.currentTimeMillis() - startTime;
        log.info("uri: " + uri + ", duration: " + duration / 100 + "ms");
        return null;
    }
}
```

ä¸Šé¢å°±ç®€å•å®ç°äº†è¯·æ±‚æ—¶é—´æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œä½ æœ‰æ²¡æœ‰æ„Ÿå—åˆ° `Zuul` è¿‡æ»¤åŠŸèƒ½çš„å¼ºå¤§äº†å‘¢ï¼Ÿ

æ²¡æœ‰ï¼Ÿå¥½çš„ã€é‚£æˆ‘ä»¬å†æ¥ã€‚

#### ä»¤ç‰Œæ¡¶é™æµ

å½“ç„¶ä¸ä»…ä»…æ˜¯ä»¤ç‰Œæ¡¶é™æµæ–¹å¼ï¼Œ`Zuul` åªè¦æ˜¯é™æµçš„æ´»å®ƒéƒ½èƒ½å¹²ï¼Œè¿™é‡Œæˆ‘åªæ˜¯ç®€å•ä¸¾ä¸ªğŸŒ°ã€‚

![image-20200225160739899](C:\Users\jiang\AppData\Roaming\Typora\typora-user-images\image-20200225160739899.png)

æˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯ **ä»¤ç‰Œæ¡¶é™æµ** å§ã€‚

é¦–å…ˆæˆ‘ä»¬ä¼šæœ‰ä¸ªæ¡¶ï¼Œå¦‚æœé‡Œé¢æ²¡æœ‰æ»¡é‚£ä¹ˆå°±ä¼šä»¥ä¸€å®š **å›ºå®šçš„é€Ÿç‡** ä¼šå¾€é‡Œé¢æ”¾ä»¤ç‰Œï¼Œä¸€ä¸ªè¯·æ±‚è¿‡æ¥é¦–å…ˆè¦ä»æ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å°±æ‹’ç»ï¼Œå¦‚æœè·å–åˆ°é‚£ä¹ˆå°±æ”¾è¡Œã€‚å¾ˆç®€å•å§ï¼Œå•Šå“ˆå“ˆã€

ä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡ `Zuul` çš„å‰ç½®è¿‡æ»¤å™¨æ¥å®ç°ä¸€ä¸‹ä»¤ç‰Œæ¡¶é™æµã€‚

```
package com.lgq.zuul.filter;

import com.google.common.util.concurrent.RateLimiter;
import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.netflix.zuul.filters.support.FilterConstants;
import org.springframework.stereotype.Component;

@Component
@Slf4j
public class RouteFilter extends ZuulFilter {
    // å®šä¹‰ä¸€ä¸ªä»¤ç‰Œæ¡¶ï¼Œæ¯ç§’äº§ç”Ÿ2ä¸ªä»¤ç‰Œï¼Œå³æ¯ç§’æœ€å¤šå¤„ç†2ä¸ªè¯·æ±‚
    private static final RateLimiter RATE_LIMITER = RateLimiter.create(2);
    @Override
    public String filterType() {
        return FilterConstants.PRE_TYPE;
    }

    @Override
    public int filterOrder() {
        return -5;
    }

    @Override
    public Object run() throws ZuulException {
        log.info("æ”¾è¡Œ");
        return null;
    }

    @Override
    public boolean shouldFilter() {
        RequestContext context = RequestContext.getCurrentContext();
        if(!RATE_LIMITER.tryAcquire()) {
            log.warn("è®¿é—®é‡è¶…è½½");
            // æŒ‡å®šå½“å‰è¯·æ±‚æœªé€šè¿‡è¿‡æ»¤
            context.setSendZuulResponse(false);
            // å‘å®¢æˆ·ç«¯è¿”å›å“åº”ç 429ï¼Œè¯·æ±‚æ•°é‡è¿‡å¤š
            context.setResponseStatusCode(429);
            return false;
        }
        return true;
    }
}
```

è¿™æ ·æˆ‘ä»¬å°±èƒ½å°†è¯·æ±‚æ•°é‡æ§åˆ¶åœ¨ä¸€ç§’ä¸¤ä¸ª





### Config æ˜¯ä»€ä¹ˆ

ç®€å•æ¥è¯´ï¼Œ`Spring Cloud Config` å°±æ˜¯èƒ½å°†å„ä¸ª åº”ç”¨/ç³»ç»Ÿ/æ¨¡å— çš„é…ç½®æ–‡ä»¶å­˜æ”¾åˆ° **ç»Ÿä¸€çš„åœ°æ–¹ç„¶åè¿›è¡Œç®¡ç†**(Git æˆ–è€… SVN)ã€‚
ä¸€èˆ¬æˆ‘ä»¬ä¼šä½¿ç”¨ `Bus` æ¶ˆæ¯æ€»çº¿ + `Spring Cloud Config` è¿›è¡Œé…ç½®çš„åŠ¨æ€åˆ·æ–°ã€‚



## å¼•å‡º Spring Cloud Bus

ä½ å¯ä»¥ç®€å•ç†è§£ä¸º `Spring Cloud Bus` çš„ä½œç”¨å°±æ˜¯**ç®¡ç†å’Œå¹¿æ’­åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ¶ˆæ¯**ï¼Œä¹Ÿå°±æ˜¯æ¶ˆæ¯å¼•æ“ç³»ç»Ÿä¸­çš„å¹¿æ’­æ¨¡å¼ã€‚å½“ç„¶ä½œä¸º **æ¶ˆæ¯æ€»çº¿** çš„ `Spring Cloud Bus` å¯ä»¥åšå¾ˆå¤šäº‹è€Œä¸ä»…ä»…æ˜¯å®¢æˆ·ç«¯çš„é…ç½®åˆ·æ–°åŠŸèƒ½ã€‚

è€Œæ‹¥æœ‰äº† `Spring Cloud Bus` ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦åˆ›å»ºä¸€ä¸ªç®€å•çš„è¯·æ±‚ï¼Œå¹¶ä¸”åŠ ä¸Š `@ResfreshScope` æ³¨è§£å°±èƒ½è¿›è¡Œé…ç½®çš„åŠ¨æ€ä¿®æ”¹äº†ï¼Œä¸‹é¢æˆ‘ç”»äº†å¼ å›¾ä¾›ä½ ç†è§£ã€‚